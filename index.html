<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Yield-Farming Position Tracker</title>

    <!-- Chart.js + time adapter -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>

    <style>
      /* Global styling */
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: #121212;
        color: #e0e0e0;
        padding: 20px;
        line-height: 1.5;
      }
      h1,
      h2 {
        color: #ffffff;
        margin-bottom: 20px;
      }
      a {
        color: #4caf50;
        text-decoration: none;
      }

      /* Flex layout */
      .top-container {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        margin-bottom: 40px;
      }
      .section {
        background: #1f1f1f;
        padding: 20px;
        border-radius: 8px;
        flex: 1 1 300px;
        min-width: 280px;
      }
      .wide-section {
        flex: 2 1 600px;
      }

      /* Form elements */
      label {
        display: block;
        margin-top: 10px;
        font-size: 14px;
      }
      input,
      button {
        width: 100%;
        padding: 10px;
        margin-top: 6px;
        background: #2c2c2c;
        color: #fff;
        border: none;
        border-radius: 6px;
      }
      input[type="file"] {
        display: none;
      }
      button {
        background: #4caf50;
        cursor: pointer;
        font-weight: bold;
      }
      button:hover {
        background: #45a049;
      }

      /* Table styling */
      table {
        width: 100%;
        margin-top: 10px;
        border-collapse: collapse;
      }
      th,
      td {
        padding: 8px 10px;
        border: 1px solid #333;
        font-size: 14px;
      }
      th {
        background: #2c2c2c;
        text-align: left;
      }
      tr:nth-child(even) {
        background: #1a1a1a;
      }
      tr:hover {
        background: #333;
      }

      /* Chart container */
      #chartContainer {
        max-width: 1000px;
        margin: 0 auto 40px;
      }
      canvas {
        background: #1e1e1e;
        border: 1px solid #333;
        border-radius: 8px;
        width: 100% !important;
        height: 500px !important;
      }
      #slopeInfo {
        margin-top: 12px;
        font-size: 16px;
        color: #4caf50;
      }

      /* Responsive */
      @media (max-width: 768px) {
        .top-container {
          flex-direction: column;
        }
      }
    </style>
  </head>

  <body>
    <h1>Yield-Farming Position Tracker</h1>

    <div class="top-container">
      <div class="section">
        <h2>Add Position</h2>
        <label>Name</label>
        <input id="posName" />
        <label>Initial Value (USD)</label>
        <input id="posValue" type="number" />
        <label>Start (Date & Time)</label>
        <input id="posStart" type="datetime-local" />
        <button id="addBtn">Add Position</button>
      </div>

      <div class="section">
        <h2>Data Management</h2>
        <button id="exportBtn">Export JSON</button>
        <input id="importFile" type="file" accept="application/json" />
        <button id="importBtn">Import JSON</button>
      </div>

      <div class="section wide-section">
        <h2>Your Positions</h2>
        <table id="positionsTable">
          <thead>
            <tr>
              <th>Name</th>
              <th>Initial</th>
              <th>Start</th>
              <th>Last Value</th>
              <th>Last Yield</th>
              <th>Last Update</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="section" id="updateSection" style="display: none">
        <h2>Update Position</h2>
        <h3 id="updateTitle"></h3>
        <label>Current Value (USD)</label>
        <input id="updValue" type="number" />
        <label>Pending Yield (USD)</label>
        <input id="updYield" type="number" />
        <button id="updBtn">Add Update</button>
      </div>
    </div>

    <div id="chartContainer" style="display: none">
      <h2>History: <span id="chartTitle"></span></h2>
      <canvas id="positionChart"></canvas>
      <div id="slopeInfo"></div>

      <table id="statsTable">
        <thead>
          <tr>
            <th>% Return (Value)</th>
            <th>% Return (Yield)</th>
            <th>Annualized Yield %</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td id="retValue">—</td>
            <td id="retYield">—</td>
            <td id="annYield">—</td>
          </tr>
        </tbody>
      </table>
    </div>

    <script>
      const $ = (id) => document.getElementById(id);
      let positions = [];
      let selectedId = null;
      let chart = null;

      const fmt = (n) =>
        Number(n).toLocaleString(undefined, { maximumFractionDigits: 0 });
      const nowLocalISOmin = () => {
        const z = (n) => String(n).padStart(2, "0"),
          d = new Date();
        return `${d.getFullYear()}-${z(d.getMonth() + 1)}-${z(d.getDate())}T${z(
          d.getHours()
        )}:${z(d.getMinutes())}`;
      };

      function buildRow(p) {
        const tr = document.createElement("tr");
        if (p.id === selectedId) tr.style.backgroundColor = "#333";
        const last = p.updates.at(-1);
        tr.innerHTML = `
    <td>${p.name}</td>
    <td>${fmt(p.initialValue)}</td>
    <td>${new Date(p.startDate).toLocaleString()}</td>
    <td>${fmt(last ? last.value : p.initialValue)}</td>
    <td>${fmt(last ? last.pendingYield : 0)}</td>
    <td>${last ? new Date(last.time).toLocaleString() : "—"}</td>
    <td>
      <button data-act="select">Select</button>
      <button data-act="update">Update</button>
      <button data-act="delete">Delete</button>
    </td>`;
        tr.querySelectorAll("button").forEach((btn) => {
          const act = btn.dataset.act;
          btn.onclick = () => {
            if (act === "select") selectPosition(p.id);
            else if (act === "update") openUpdate(p.id);
            else if (act === "delete") deletePosition(p.id);
          };
        });
        return tr;
      }

      function refreshTable() {
        const tbody = $("positionsTable").querySelector("tbody");
        tbody.innerHTML = "";
        positions.forEach((p) => tbody.appendChild(buildRow(p)));
      }

      function addPosition() {
        const name = $("posName").value.trim();
        const val = Number($("posValue").value);
        const start = $("posStart").value;
        if (!name || !val || !start) {
          alert("All fields required");
          return;
        }
        positions.push({
          id: Date.now().toString(),
          name,
          initialValue: val,
          startDate: start,
          updates: [],
        });
        refreshTable();
        $("posName").value = "";
        $("posValue").value = "";
        $("posStart").value = nowLocalISOmin();
      }

      function deletePosition(id) {
        const p = positions.find((x) => x.id === id);
        if (!confirm(`Delete position “${p.name}”?`)) return;
        positions = positions.filter((x) => x.id !== id);
        if (selectedId === id) {
          selectedId = null;
          $("updateSection").style.display = "none";
          $("chartContainer").style.display = "none";
        }
        refreshTable();
      }

      function openUpdate(id) {
        selectedId = id;
        $("updateSection").style.display = "block";
        const p = positions.find((x) => x.id === id);
        $("updateTitle").textContent = p.name;
        $("updValue").value = "";
        $("updYield").value = "";
        selectPosition(id);
      }

      function addUpdate() {
        const val = Number($("updValue").value);
        const yld = Number($("updYield").value);
        if (isNaN(val) || isNaN(yld)) {
          alert("Numbers required");
          return;
        }
        const p = positions.find((x) => x.id === selectedId);
        p.updates.push({ time: Date.now(), value: val, pendingYield: yld });
        refreshTable();
        drawChart(p);
        $("updValue").value = "";
        $("updYield").value = "";
      }

      function selectPosition(id) {
        selectedId = id;
        refreshTable();
        const p = positions.find((x) => x.id === id);
        $("chartTitle").textContent = p.name;
        $("chartContainer").style.display = "block";
        drawChart(p);
      }

      function drawChart(p) {
        const valuePts = [{ x: new Date(p.startDate), y: p.initialValue }];
        const yieldPts = [{ x: new Date(p.startDate), y: 0 }];
        p.updates.forEach((u) => {
          valuePts.push({ x: new Date(u.time), y: u.value });
          yieldPts.push({ x: new Date(u.time), y: u.pendingYield });
        });

        if (chart) chart.destroy();
        chart = new Chart($("positionChart"), {
          type: "line",
          data: {
            datasets: [
              {
                label: "Position Value",
                data: valuePts,
                yAxisID: "y",
                borderColor: "#4caf50",
                tension: 0.3,
              },
              {
                label: "Pending Yield",
                data: yieldPts,
                yAxisID: "y1",
                borderColor: "#ff9800",
                borderDash: [5, 5],
                tension: 0.3,
              },
            ],
          },
          options: {
            responsive: true,
            scales: {
              x: {
                type: "time",
                ticks: { color: "#ccc", maxTicksLimit: 6 },
                title: { text: "Date & Time", display: true, color: "#ccc" },
              },
              y: {
                title: { text: "Value (USD)", display: true, color: "#ccc" },
                ticks: { color: "#ccc" },
              },
              y1: {
                position: "right",
                grid: { drawOnChartArea: false },
                title: { text: "Yield (USD)", display: true, color: "#ccc" },
                ticks: { color: "#ccc" },
              },
            },
          },
        });

        const initial = p.initialValue;
        const lastVal = valuePts.at(-1).y;
        const lastYld = yieldPts.at(-1).y;
        const retValuePct = ((lastVal - initial) / initial) * 100;
        const retYieldPct = (lastYld / initial) * 100;
        const days = (valuePts.at(-1).x - valuePts[0].x) / 86400000;
        const annYieldPct = days > 0 ? retYieldPct * (365 / days) : NaN;

        $("retValue").textContent = isFinite(retValuePct)
          ? retValuePct.toFixed(2) + "%"
          : "—";
        $("retYield").textContent = isFinite(retYieldPct)
          ? retYieldPct.toFixed(2) + "%"
          : "—";
        $("annYield").textContent = isFinite(annYieldPct)
          ? annYieldPct.toFixed(2) + "%"
          : "—";

        if (yieldPts.length >= 2) {
          const n = yieldPts.length;
          const sumX = yieldPts.reduce((sum, pt) => sum + pt.x.getTime(), 0);
          const sumY = yieldPts.reduce((sum, pt) => sum + pt.y, 0);
          const sumXY = yieldPts.reduce(
            (sum, pt) => sum + pt.x.getTime() * pt.y,
            0
          );
          const sumXX = yieldPts.reduce(
            (sum, pt) => sum + pt.x.getTime() * pt.x.getTime(),
            0
          );
          const slope = (n * sumXY - sumX * sumY) / (n * sumXX - sumX * sumX);
          const slopePerDay = slope * 86400000;
          $(
            "slopeInfo"
          ).textContent = `Average Yield Growth: ${slopePerDay.toFixed(
            2
          )} USD/day`;
        } else {
          $("slopeInfo").textContent = "Not enough data for trendline.";
        }
      }

      function exportJSON() {
        const blob = new Blob([JSON.stringify(positions, null, 2)], {
          type: "application/json",
        });
        const url = URL.createObjectURL(blob);
        Object.assign(document.createElement("a"), {
          href: url,
          download: "yield_positions.json",
        }).click();
        URL.revokeObjectURL(url);
      }

      function importJSON(file) {
        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const data = JSON.parse(e.target.result);
            if (!Array.isArray(data)) throw "Invalid file";
            positions = data;
            refreshTable();
            $("updateSection").style.display = "none";
            $("chartContainer").style.display = "none";
          } catch (err) {
            alert("Import failed: " + err);
          }
        };
        reader.readAsText(file);
      }

      $("addBtn").onclick = addPosition;
      $("updBtn").onclick = addUpdate;
      $("exportBtn").onclick = exportJSON;
      $("importBtn").onclick = () => $("importFile").click();
      $("importFile").addEventListener("change", (e) => {
        if (e.target.files[0]) importJSON(e.target.files[0]);
      });

      $("posStart").value = nowLocalISOmin();
      refreshTable();
    </script>
  </body>
</html>
