<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Yield-Farming Position Tracker</title>

    <!-- Chart.js + Time Adapter -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>

    <style>
      body {
        font-family: Arial, Helvetica, sans-serif;
        margin: 20px;
        background: #121212;
        color: #e0e0e0;
        line-height: 1.5;
      }
      h1 {
        margin-bottom: 20px;
        color: #ffffff;
      }
      h2 {
        margin-top: 0;
        font-size: 20px;
      }
      label {
        display: block;
        margin-top: 8px;
        font-size: 14px;
      }
      input,
      button {
        padding: 6px;
        margin-top: 4px;
        background: #1f1f1f;
        color: #e0e0e0;
        border: 1px solid #333;
        width: 100%;
      }
      button:hover {
        background: #333;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
        background: #1f1f1f;
      }
      th,
      td {
        border: 1px solid #444;
        padding: 6px;
        text-align: left;
        font-size: 14px;
      }
      tr.selected {
        background: #333;
      }
      th {
        background: #222;
      }
      .inline {
        display: inline-block;
        margin-right: 10px;
      }
      .warn {
        color: #ff5555;
        font-size: 0.9em;
        margin-left: 6px;
      }
      #statsTable th {
        text-align: center;
        background: #222;
      }
      #statsTable td {
        text-align: right;
      }
      .flex-top {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        margin-bottom: 30px;
      }
      .flex-top section {
        background: #1f1f1f;
        padding: 15px;
        border: 1px solid #333;
        border-radius: 8px;
        flex: 1 1 300px;
        min-width: 250px;
      }
      #chartContainer {
        margin-top: 20px;
        max-width: 900px;
        margin-left: auto;
        margin-right: auto;
      }
      canvas {
        background: #1f1f1f;
        border: 1px solid #333;
        width: 100% !important;
        height: 500px !important;
      }
    </style>
  </head>

  <body>
    <h1>
      Yield-Farming Position Tracker
      <span class="warn">(data not saved — export before closing!)</span>
    </h1>

    <div class="flex-top">
      <section>
        <h2>Add Position</h2>
        <label>Name <input id="posName" /></label>
        <label>Initial Value <input id="posValue" type="number" /></label>
        <label
          >Start (date & time) <input id="posStart" type="datetime-local"
        /></label>
        <button id="addBtn">Add</button>
      </section>

      <section>
        <h2>Data File</h2>
        <button id="exportBtn" class="inline">Export JSON</button>
        <input
          id="importFile"
          type="file"
          accept="application/json"
          style="display: none"
        />
        <button id="importBtn" class="inline">Import JSON</button>
      </section>

      <section style="flex: 2 1 600px">
        <h2>Positions</h2>
        <table id="positionsTable">
          <thead>
            <tr>
              <th>Name</th>
              <th>Initial</th>
              <th>Start</th>
              <th>Last Value</th>
              <th>Last Yield</th>
              <th>Last Update</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </section>

      <section id="updateSection" style="display: none">
        <h2>Update</h2>
        <h3 id="updateTitle"></h3>
        <label>Current Value <input id="updValue" type="number" /></label>
        <label>Pending Yield <input id="updYield" type="number" /></label>
        <button id="updBtn">Add Update</button>
      </section>
    </div>

    <section id="chartContainer" style="display: none">
      <h2>History: <span id="chartTitle"></span></h2>
      <canvas id="positionChart"></canvas>
      <div
        id="slopeInfo"
        style="margin-top: 10px; font-size: 16px; color: #4caf50"
      ></div>

      <table id="statsTable">
        <thead>
          <tr>
            <th>% Return (Value)</th>
            <th>% Return (Yield)</th>
            <th>Annualized Yield %</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td id="retValue">—</td>
            <td id="retYield">—</td>
            <td id="annYield">—</td>
          </tr>
        </tbody>
      </table>
    </section>

    <script>
      const $ = (id) => document.getElementById(id);
      let positions = [];
      let selectedId = null;
      let chart = null;

      const fmt = (n) =>
        Number(n).toLocaleString(undefined, { maximumFractionDigits: 0 });
      const nowLocalISOmin = () => {
        const z = (n) => String(n).padStart(2, "0"),
          d = new Date();
        return `${d.getFullYear()}-${z(d.getMonth() + 1)}-${z(d.getDate())}T${z(
          d.getHours()
        )}:${z(d.getMinutes())}`;
      };

      function buildRow(p) {
        const tr = document.createElement("tr");
        if (p.id === selectedId) tr.classList.add("selected");
        const last = p.updates.at(-1);
        tr.innerHTML = `
    <td>${p.name}</td>
    <td>${fmt(p.initialValue)}</td>
    <td>${new Date(p.startDate).toLocaleString()}</td>
    <td>${fmt(last ? last.value : p.initialValue)}</td>
    <td>${fmt(last ? last.pendingYield : 0)}</td>
    <td>${last ? new Date(last.time).toLocaleString() : "—"}</td>
    <td>
      <button data-act="select">Select</button>
      <button data-act="update">Update</button>
      <button data-act="delete">Delete</button>
    </td>`;
        tr.querySelectorAll("button").forEach((btn) => {
          const act = btn.dataset.act;
          btn.onclick = () => {
            if (act === "select") selectPosition(p.id);
            else if (act === "update") openUpdate(p.id);
            else if (act === "delete") deletePosition(p.id);
          };
        });
        return tr;
      }

      function refreshTable() {
        const tbody = $("positionsTable").querySelector("tbody");
        tbody.innerHTML = "";
        positions.forEach((p) => tbody.appendChild(buildRow(p)));
      }

      function addPosition() {
        const name = $("posName").value.trim();
        const val = Number($("posValue").value);
        const start = $("posStart").value;
        if (!name || !val || !start) {
          alert("All fields required");
          return;
        }
        positions.push({
          id: Date.now().toString(),
          name,
          initialValue: val,
          startDate: start,
          updates: [],
        });
        refreshTable();
        $("posName").value = "";
        $("posValue").value = "";
        $("posStart").value = nowLocalISOmin();
      }

      function deletePosition(id) {
        const p = positions.find((x) => x.id === id);
        if (!confirm(`Delete position “${p.name}”?`)) return;
        positions = positions.filter((x) => x.id !== id);
        if (selectedId === id) {
          selectedId = null;
          $("updateSection").style.display = "none";
          $("chartContainer").style.display = "none";
        }
        refreshTable();
      }

      function openUpdate(id) {
        selectedId = id;
        $("updateSection").style.display = "block";
        const p = positions.find((x) => x.id === id);
        $("updateTitle").textContent = p.name;
        $("updValue").value = "";
        $("updYield").value = "";
        selectPosition(id);
      }

      function addUpdate() {
        const val = Number($("updValue").value);
        const yld = Number($("updYield").value);
        if (isNaN(val) || isNaN(yld)) {
          alert("Numbers required");
          return;
        }
        const p = positions.find((x) => x.id === selectedId);
        p.updates.push({ time: Date.now(), value: val, pendingYield: yld });
        refreshTable();
        drawChart(p);
        $("updValue").value = "";
        $("updYield").value = "";
      }

      function selectPosition(id) {
        selectedId = id;
        refreshTable();
        const p = positions.find((x) => x.id === id);
        $("chartTitle").textContent = p.name;
        $("chartContainer").style.display = "block";
        drawChart(p);
      }

      function drawChart(p) {
        const valuePts = [{ x: new Date(p.startDate), y: p.initialValue }];
        const yieldPts = [{ x: new Date(p.startDate), y: 0 }];
        p.updates.forEach((u) => {
          valuePts.push({ x: new Date(u.time), y: u.value });
          yieldPts.push({ x: new Date(u.time), y: u.pendingYield });
        });

        if (chart) chart.destroy();
        chart = new Chart($("positionChart"), {
          type: "line",
          data: {
            datasets: [
              {
                label: "Position Value",
                data: valuePts,
                yAxisID: "y",
                fill: false,
                borderColor: "#4caf50",
                tension: 0.3,
              },
              {
                label: "Pending Yield",
                data: yieldPts,
                yAxisID: "y1",
                fill: false,
                borderColor: "#ff9800",
                borderDash: [5, 5],
                tension: 0.3,
              },
            ],
          },
          options: {
            responsive: true,
            interaction: { mode: "index", intersect: false },
            scales: {
              x: {
                type: "time",
                time: {
                  tooltipFormat: "yyyy-MM-dd HH:mm",
                  displayFormats: {
                    hour: "MMM dd HH:mm",
                    minute: "MMM dd HH:mm",
                  },
                },
                title: {
                  display: true,
                  text: "Date & Time",
                  color: "#ccc",
                  font: { size: 18 },
                },
                ticks: { color: "#ccc", font: { size: 16 }, maxTicksLimit: 6 },
              },
              y: {
                title: {
                  display: true,
                  text: "USD (Value)",
                  color: "#ccc",
                  font: { size: 18 },
                },
                ticks: { color: "#ccc", font: { size: 16 } },
              },
              y1: {
                title: {
                  display: true,
                  text: "USD (Yield)",
                  color: "#ccc",
                  font: { size: 18 },
                },
                position: "right",
                grid: { drawOnChartArea: false },
                ticks: { color: "#ccc", font: { size: 16 } },
              },
            },
            plugins: {
              legend: { labels: { color: "#ccc", font: { size: 18 } } },
              tooltip: {
                titleFont: { size: 18 },
                bodyFont: { size: 16 },
                footerFont: { size: 14 },
              },
            },
          },
        });

        const initial = p.initialValue;
        const lastVal = valuePts.at(-1).y;
        const lastYld = yieldPts.at(-1).y;
        const retValuePct = ((lastVal - initial) / initial) * 100;
        const retYieldPct = (lastYld / initial) * 100;
        const days = (valuePts.at(-1).x - valuePts[0].x) / 86400000;
        const annYieldPct = days > 0 ? retYieldPct * (365 / days) : NaN;

        $("retValue").textContent = isFinite(retValuePct)
          ? retValuePct.toFixed(2) + " %"
          : "—";
        $("retYield").textContent = isFinite(retYieldPct)
          ? retYieldPct.toFixed(2) + " %"
          : "—";
        $("annYield").textContent = isFinite(annYieldPct)
          ? annYieldPct.toFixed(2) + " %"
          : "—";

        // Calculate and show linear fit (yield growth USD/day)
        if (yieldPts.length >= 2) {
          const n = yieldPts.length;
          const sumX = yieldPts.reduce((sum, pt) => sum + pt.x.getTime(), 0);
          const sumY = yieldPts.reduce((sum, pt) => sum + pt.y, 0);
          const sumXY = yieldPts.reduce(
            (sum, pt) => sum + pt.x.getTime() * pt.y,
            0
          );
          const sumXX = yieldPts.reduce(
            (sum, pt) => sum + pt.x.getTime() * pt.x.getTime(),
            0
          );
          const slope = (n * sumXY - sumX * sumY) / (n * sumXX - sumX * sumX);
          const slopePerDay = slope * 86400000; // ms → day
          $(
            "slopeInfo"
          ).textContent = `Average Yield Growth: ${slopePerDay.toFixed(
            2
          )} USD/day`;
        } else {
          $("slopeInfo").textContent = "Not enough points for trendline.";
        }
      }

      function exportJSON() {
        const blob = new Blob([JSON.stringify(positions, null, 2)], {
          type: "application/json",
        });
        const url = URL.createObjectURL(blob);
        Object.assign(document.createElement("a"), {
          href: url,
          download: "yield_positions.json",
        }).click();
        URL.revokeObjectURL(url);
      }

      function importJSON(file) {
        const reader = new FileReader();
        reader.onload = (event) => {
          try {
            const data = JSON.parse(event.target.result);
            if (!Array.isArray(data)) throw "Invalid file format";
            positions = data;
            selectedId = null;
            refreshTable();
            $("updateSection").style.display = "none";
            $("chartContainer").style.display = "none";
          } catch (err) {
            alert("Import failed: " + err);
          }
        };
        reader.readAsText(file);
      }

      // Connect buttons
      $("addBtn").onclick = addPosition;
      $("updBtn").onclick = addUpdate;
      $("exportBtn").onclick = exportJSON;
      $("importBtn").onclick = () => $("importFile").click();
      $("importFile").addEventListener("change", (e) => {
        const file = e.target.files[0];
        if (file) importJSON(file);
      });

      $("posStart").value = nowLocalISOmin();
      refreshTable();
    </script>
  </body>
</html>
